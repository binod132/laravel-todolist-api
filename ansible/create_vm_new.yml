- name: Clone running VM on ESXi
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Clone running VM (jump-server)
      community.vmware.vmware_vm_vm:
        hostname: "192.168.130.210"  # ESXi host IP
        username: "root"  # ESXi root username
        password: "Mid@s123"  # ESXi root password
        datacenter: "ha-datacenter"  # Specify the datacenter
        datastore: "datastore1"  # Specify the correct datastore
        folder: "/vmfs/volumes/datastore1/vm"  # Folder to create the new VM in
        name: "new-ansible-vm"  # The name of the new VM
        state: "powered-on"  # Power on the new VM
        clone:
          parent_vm: "jump-server"  # Specify the source running VM
          customize: true  # Enable customization
          customize_spec:
            hostname: "new-ansible-vm"  # Set the hostname for the new VM
            memory_mb: 8192  # Memory for the new VM
            num_cpus: 2  # CPUs for the new VM
            network:
              - name: "VM Network"  # Specify the network for the new VM
        validate_certs: false  # Skip certificate validation (optional)
- name: Clone a running VM and create a new VM
  hosts: localhost
  gather_facts: no
  tasks:

    # Clone the VM
    - name: Instant Clone a VM
      community.vmware.vmware_guest_instant_clone:
        hostname: "192.168.130.210"
        username: "root"
        password: "Mid@s123"
        validate_certs: false
        folder: "/vmfs/volumes/datastore1/vm"  # The folder where the new VM will be created
        datastore: "datastore1"  # The datastore for the new VM
        datacenter: "ha-datacenter"  # The datacenter to use
        host: "localhost.localdomain"  # The ESXi host where the new VM will be placed
        name: "ansible-vm"  # The name of the new VM
        parent_vm: "jump-server"  # The name of the running VM to clone from
        resource_pool: ""  # The resource pool to place the new VM
      register: vm_clone
      delegate_to: localhost

