---
- name: Create a new VM from template on ESXi host
  hosts: esxi_host
  gather_facts: no

  tasks:
    - name: Clone VM from template
      vmware_guest:
        hostname: "{{ ansible_host }}"
        username: root
        password: "{{ ansible_ssh_pass }}"
        validate_certs: no
        name: "new-ansible-vm"
        template: "jump-server"
        state: powered_on
        hardware:
          num_cpus: 2
          memory_mb: 4096
          num_cpu_cores_per_socket: 1
        networks:
          - name: "VM Network"
            ip: "static"  # Set to static IP
            ip_address: "192.168.130.12"  # Static IP address
            netmask: "255.255.255.0"  # Subnet mask
            gateway: "192.168.130.1"  # Gateway IP
        disk:
          - size_gb: 50
            type: thin
            datastore: "datastore1"

    - name: Power on the new VM
      vmware_vm_vm_d:
        hostname: "{{ ansible_host }}"
        username: root
        password: "{{ ansible_ssh_pass }}"
        validate_certs: no
        name: "new-ansible-vm"
        state: powered_on
